# Kumpli Recipes Automation

Automated validation, generation, and deployment of recipe collection to GitHub Pages.

## Quick Start

1. **Prerequisites:**
   ```bash
   pip install -r requirements.txt  # Installs: Pillow, Jinja2, jsonschema, markdown
   ```

2. **Set up GitHub deployment token:**
   - Go to GitHub Settings â†’ Developer settings â†’ Personal access tokens
   - Create a token with `repo` permissions
   - Add it as a repository secret named `DEPLOY_TOKEN`

3. **Push to main branch** - GitHub Actions will automatically:
   - âœ… Validate all recipes (strict schema validation)
   - âœ… Generate HTML pages with optimized images
   - âœ… Create combined markdown for e-book
   - âœ… Generate EPUB with embedded images
   - âœ… Deploy to `HunBug.github.io/recipes/`

## Recipe Structure

Each recipe lives in its own folder:
```
recipes/
  â”œâ”€â”€ recipe-name/
  â”‚   â”œâ”€â”€ recipe.json          # Structured recipe data (validated against schema)
  â”‚   â”œâ”€â”€ story.md             # Recipe story sections (Background, Kumpli Notes, Cooking Moments)
  â”‚   â”œâ”€â”€ illustration.png     # Main recipe illustration
  â”‚   â”œâ”€â”€ photo-1.png          # Cooking moment photos
  â”‚   â””â”€â”€ photo-2.png
```

## Tools

### Validation
Validates all recipes against JSON schema with strict checking:
```bash
python scripts/validate_recipes.py recipes/
```
- âœ… Checks recipe.json structure (ingredients, instructions, metadata)
- âœ… Validates story.md sections (Background, Kumpli Notes, Cooking Moments)
- âœ… Enforces schema compliance (`additionalProperties: false`)
- âŒ Exits with code 1 on errors (fails CI/CD)

### Generation
Generates HTML pages, combined markdown, and optimized images:
```bash
python scripts/generate_from_json.py --input-dir recipes --output-dir dist
```
- ğŸ“„ Creates individual HTML page per recipe
- ğŸ“„ Generates `index.html` (table of contents)
- ğŸ“„ Creates `kumpli-recipes.md` (combined e-book markdown)
- ğŸ–¼ï¸ Optimizes images (PNGâ†’JPEG, 85% quality, max 1200px, progressive)
- ğŸ“Š Outputs to `dist/` with relative image paths

## Output Structure

Generated in `dist/` directory:
```
dist/
â”œâ”€â”€ index.html                    # Recipe table of contents
â”œâ”€â”€ recipe-name.html              # Individual recipe pages (10 files)
â”œâ”€â”€ kumpli-recipes.md            # Combined markdown for e-book
â”œâ”€â”€ kumpli-recipes.epub          # E-book with embedded images (generated by Pandoc)
â”œâ”€â”€ book.html                    # Standalone HTML book (generated by Pandoc)
â”œâ”€â”€ style.css                    # CSS (created by GitHub Actions)
â””â”€â”€ images/
    â””â”€â”€ recipes/
        â””â”€â”€ recipe-name/
            â”œâ”€â”€ illustration.jpg
            â”œâ”€â”€ photo-1.jpg
            â””â”€â”€ photo-2.jpg
```

## Local Development & Testing

### Quick Build (recommended)
```bash
./scripts/build_local.sh
# Or specify custom directories:
./scripts/build_local.sh recipes dist
```
This validates, generates everything, and creates EPUB in one step.

### Preview locally
```bash
python -m http.server 8000 --directory dist
# Visit: http://localhost:8000/
```

### Manual Steps

**1. Validate recipes** (required before commit)
```bash
python scripts/validate_recipes.py recipes/
```

**2. Generate output**
```bash
python scripts/generate_from_json.py --input-dir recipes --output-dir dist
```

**3. Generate EPUB** (optional, requires Pandoc)
```bash
cd dist
pandoc kumpli-recipes.md -o kumpli-recipes.epub --metadata title="Kumpli Recipes"
cd ..
```

## File Structure

```
â”œâ”€â”€ .github/workflows/build-and-deploy.yml  # CI/CD workflow
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ generate_from_json.py               # Main generator (HTML + markdown + images)
â”‚   â”œâ”€â”€ validate_recipes.py                 # Schema validator
â”‚   â””â”€â”€ archived/                           # Old/deprecated scripts
â”œâ”€â”€ templates/                              # Jinja2 templates
â”‚   â”œâ”€â”€ recipe-page.html.j2                 # Individual recipe HTML
â”‚   â”œâ”€â”€ index.html.j2                       # Table of contents
â”‚   â”œâ”€â”€ recipe.md.j2                        # Recipe markdown template
â”‚   â”œâ”€â”€ chapter.md.j2                       # Chapter with story sections
â”‚   â””â”€â”€ book.md.j2                          # Combined book template
â”œâ”€â”€ recipes/
â”‚   â””â”€â”€ recipe-name/
â”‚       â”œâ”€â”€ recipe.json                     # Validated structured data
â”‚       â”œâ”€â”€ story.md                        # Story sections
â”‚       â””â”€â”€ *.png                           # Images (optimized during generation)
â”œâ”€â”€ recipe.schema.json                      # JSON Schema for validation
â”œâ”€â”€ reference/
â”‚   â”œâ”€â”€ story-sections.json                 # Story section configuration
â”‚   â””â”€â”€ tags.json                           # Tag definitions
â””â”€â”€ dist/                                   # Generated output (not committed)
```

## Deployment

After successful GitHub Actions run:
- **Website:** https://hunbug.github.io/recipes/
- **E-book:** https://hunbug.github.io/recipes/kumpli-recipes.epub
- **Individual recipes:** https://hunbug.github.io/recipes/recipe-name.html

## Troubleshooting

**Validation fails:**
- Check error message for specific field/file
- Ensure recipe.json matches schema (run validator locally)
- See `recipe.schema.json` for required fields

**Missing images:**
- EPUB: Pandoc must run from `dist/` directory (images at `dist/images/recipes/`)
- HTML: Images use relative paths (`images/recipes/...`)

**Generation fails:**
- Ensure `markdown` library is installed: `pip install markdown`
- Check recipe.json is valid JSON (use JSON linter)

## Archived Scripts

Old scripts moved to `scripts/archived/`:
- `generate_ebook.py` - replaced by `generate_from_json.py`
- `optimize_images.py` - now integrated into generator
- `local_build.sh` - manual steps documented above
- `recipe_template_generator.py` - use schema directly
- Other deprecated tools
