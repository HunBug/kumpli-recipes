name: Build and Deploy Recipes

on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - 'learning/**'
  pull_request:
    branches: [ main, master ]
    paths-ignore:
      - 'learning/**'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      # Set this repository variable in GitHub → Settings → Secrets and variables → Actions → Variables
      # Example: PUBLISH_BRANCH=deploy to publish to 'deploy' branch of HunBug.github.io
      PUBLISH_BRANCH: ${{ vars.PUBLISH_BRANCH }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Pandoc
        run: |
          wget https://github.com/jgm/pandoc/releases/download/3.1.8/pandoc-3.1.8-1-amd64.deb
          sudo dpkg -i pandoc-3.1.8-1-amd64.deb

      - name: Validate recipes
        run: |
          python scripts/validate_recipes.py recipes/

      - name: Generate recipes (HTML + Markdown + optimized images)
        run: |
          python scripts/generate_from_json.py --input-dir recipes --output-dir dist

      - name: Generate EPUB
        run: |
          cd dist
          pandoc kumpli-recipes.md -o kumpli-recipes.epub --metadata title="Kumpli Recipes"

      - name: Generate standalone book HTML
        run: |
          cd dist
          pandoc kumpli-recipes.md -o book.html --standalone --metadata title="Kumpli Recipes" --css style.css

      - name: Generate ToC index.html already created by generator
        run: |
          test -f dist/index.html

      - name: Deploy to external repository (recipes/ in target branch)
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        env:
          DEPLOY_TOKEN: ${{ secrets.DEPLOY_TOKEN }}
          EXTERNAL_REPOSITORY: HunBug/HunBug.github.io
        run: |
          set -e
          BRANCH="${PUBLISH_BRANCH:-main}"
          echo "Publishing to branch: ${BRANCH}"
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          # Clone full history to ensure branch refs are available
          git clone https://${DEPLOY_TOKEN}@github.com/${EXTERNAL_REPOSITORY}.git pages
          cd pages
          # Fetch the target branch explicitly
          git fetch origin "${BRANCH}" --prune || true
          if git show-ref --verify --quiet "refs/remotes/origin/${BRANCH}"; then
            git checkout -B "${BRANCH}" "origin/${BRANCH}"
          else
            echo "Target branch '${BRANCH}' not found remotely. Creating an orphan branch."
            git checkout --orphan "${BRANCH}"
            git reset --hard
          fi
          # Replace recipes/ with new build
          git rm -r --quiet recipes || true
          mkdir -p recipes
          cp -r ../dist/* recipes/

          git add -A
          if git diff --cached --quiet; then
            echo "No changes to deploy."
            exit 0
          fi
          git commit -m "Deploy recipes - $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          git push origin "${BRANCH}"
